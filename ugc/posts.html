<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Posts</title>

<!-- Topbar component (your site has this) -->
<script type="module" src="/dp-topbar.js"></script>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>

<style>
:root{
  --bg: #171717;
  --card: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.03));
  --muted: #9aa0b2;
  --text: #e9e6ef;
  --accent-1: #1f1f1f;
  --accent-2: #1f1f1f;
  --glass: rgba(255,255,255,0.03);
  --border: rgba(255,255,255,0.06);
  --radius: 14px;
  --max-width: 960px;
  --card-gap: 18px;
}

*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;overflow-x:hidden;}
/* Remove margin/padding from body for topbar */
body {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 0; /* removed 20px */
}

/* Make topbar full width and flush to top */
dp-topbar {
  width: 100%;
  margin: 0;      /* remove previous margin-bottom */
  display: block;
  flex-shrink: 0;
}

.container{ width:100%; max-width:var(--max-width); }

/* header */
.header{
  display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px;
}
.page-title{
  font-family: 'Orbitron', system-ui, sans-serif;
  font-size:28px; letter-spacing:0.6px; margin:0;
  text-shadow: 0 6px 20px rgba(255,255,255,0.06);
  color:var(--text);
}
.header-controls{ display:flex; gap:12px; align-items:center; }

/* mobile adjustments */
@media (max-width: 700px) {
  /* make container narrower than screen */
  .container {
    width: calc(100% - 24px); /* 12px padding each side */
    max-width: none; /* ignore desktop max-width on small screens */
    margin: 0 auto;
  }

  /* card gets full container width but has some internal padding */
  .post-card {
    padding: 12px;
  }

  /* avatar smaller but keep aspect ratio */
/* Strong avatar rules â€” forces a perfect circle and prevents stretching */
.avatar{
  display: block;               /* avoid flex stretch shenanigans */
  width: 48px;
  height: 48px;
  flex: 0 0 auto;               /* don't let flex change size */
  min-width: 48px;
  border-radius: 50%;           /* circle */
  overflow: hidden;             /* crop background or child img */
  background-repeat: no-repeat;
  background-size: cover;       /* fill without distortion */
  background-position: center;
  aspect-ratio: 1 / 1;          /* ensures a square shape */
  border: 2px solid var(--border);
  position: relative;           /* for overlay/frame positioning */
}

/* Make sure any frame overlay matches the avatar perfectly */
.profile-pic-frame {
  position: absolute;
  inset: 0;                     /* fills the avatar exactly */
  border-radius: 50%;
  background-size: cover;
  background-position: center;
  pointer-events: none;
}

  /* post images should not stretch full width */
  .post-images img {
    max-width: 100%;
    max-height: 180px;
    object-fit: cover;
    border-radius: 10px;
    border: 1px solid var(--border);
  }
}
@media (min-width: 701px){
  .avatar{ width:56px; height:56px; min-width:56px; aspect-ratio:1/1; }
}

/* Slightly smaller on small phones */
@media (max-width: 360px){
  .avatar{ width:40px; height:40px; min-width:40px; }
}



/* posts list */
.posts-list{ display:flex; flex-direction:column; gap:var(--card-gap); }

/* card */
.post-card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:16px;
  transition: transform .14s ease, box-shadow .14s ease;
}

.author-row{ display:flex; gap:12px; align-items:center; justify-content:space-between; }
.author-left{ display:flex; gap:12px; align-items:center; min-width:0; }
.avatar{
  width:56px; height:56px; background-repeat: no-repeat; border-radius:50%; background-size:cover; background-position:center; flex:0 0 56px;
  border:2px solid var(--border);
}
.author-meta{ min-width:0; overflow:hidden; }
.display-name{ display:flex; gap:8px; align-items:center; font-weight:700; font-size:1.05rem; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.email-text{ font-size:13px; color:var(--muted); margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.verified-badge{ width:18px; height:18px; display:inline-block; background-image:url('/assets/verified.png'); background-size:contain; background-repeat:no-repeat; margin-left:4px; }

/* post content */
.post-text{ margin-top:12px; font-size:15px; color:var(--text); line-height:1.5; white-space:pre-wrap; }
.post-images{ margin-top:12px; display:flex; background-repeat: no-repeat; gap:10px; flex-wrap:wrap; }
.post-images img{ max-width:100%; max-height:320px; object-fit:cover; border-radius:10px; border:1px solid var(--border); }

/* actions row */
.actions-row{ display:flex; gap:8px; margin-top:12px; align-items:center; flex-wrap:wrap; }
.icon-btn{
  display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:10px; background:transparent; border:1px solid var(--border);
  color:var(--text); cursor:pointer; transition: background .12s ease, transform .06s ease, box-shadow .12s ease;
}
.icon{ width:18px; height:18px; display:inline-block; vertical-align:middle; fill:currentColor; opacity:0.95; }

/* like active */
.icon-btn.liked{ background:linear-gradient(90deg,var(--accent-1),var(--accent-2)); color:white; box-shadow:0 8px 30px rgba(255,255,255,0.03); border-color:transparent; }
.like-count{ font-size:13px; color:inherit; }

/* responsive */
@media (max-width:700px){ .avatar{ width:48px; height:48px; } .display-name{ font-size:1rem; } .post-images img{ max-height:180px; } .page-title{ font-size:22px; } }

/* small helpers */
.sep{ height:1px; background:var(--border); margin:12px 0; border-radius:2px; }
.muted{ color:var(--muted); font-size:13px; }

/* accessibility: prefers-reduced-motion */
@media (prefers-reduced-motion: reduce){
  .post-card, .icon-btn{ transition:none; animation:none; transform:none; }
}
</style>
</head>
<body>
  <dp-topbar></dp-topbar>

  <div class="container">
    <div class="header">
    </div>

    <div id="postsList" class="posts-list" aria-live="polite"></div>
  </div>

<script>
/* Firebase init */
const firebaseConfig = {
  apiKey: "AIzaSyCAPZF2zwU6z5rhikrIVZ4TVxf1tS5aTbA",
  authDomain: "darkpurpleof-s-website.firebaseapp.com",
  projectId: "darkpurpleof-s-website",
  storageBucket: "darkpurpleof-s-website.firebasestorage.app",
  messagingSenderId: "520651082420",
  appId: "1:520651082420:web:bb05c0c3fd64517952e5e1"
};
if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

/* Utility: attempt to fetch user doc by a few keys for robustness */
async function getUserDoc(email){
  if(!email) return null;
  const lower = String(email).toLowerCase();
  // 1) direct doc
  try{
    let snap = await db.collection('user_data').doc(lower).get();
    if(snap.exists) return { id: snap.id, data: snap.data() };
    // 2) encoded key
    snap = await db.collection('user_data').doc(encodeURIComponent(lower)).get();
    if(snap.exists) return { id: snap.id, data: snap.data() };
    // 3) fallback query
    const q = await db.collection('user_data').where('email','==', lower).limit(1).get();
    if(!q.empty) return { id: q.docs[0].id, data: q.docs[0].data() };
    // nothing
    return null;
  }catch(err){
    console.warn('getUserDoc error', err);
    return null;
  }
}

/* Small helper to safely escape text content for insertion into DOM elements (we use textContent so it's usually safe) */
function safeText(s){ return (s === undefined || s === null) ? '' : String(s); }

/* Icon SVGs */
const ICONS = {
  heart: function(filled){
    filled = filled || false; // fallback for plain JS
    if(filled){
      return `<svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M12 21s-7.5-4.5-10-8c-1.9-2.6-1-6 2-7.5C6 4 8.5 5 9.5 6.2 10.5 5 13 4 16 5.5c3 1.5 3.9 4.9 2 7.5-2.5 3.5-10 8-10 8z"/>
      </svg>`;
    } else {
      return `<svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
        <path fill="none" stroke="currentColor" stroke-width="1.6" d="M12 21s-7.5-4.5-10-8c-1.9-2.6-1-6 2-7.5C6 4 8.5 5 9.5 6.2 10.5 5 13 4 16 5.5c3 1.5 3.9 4.9 2 7.5-2.5 3.5-10 8-10 8z"/>
      </svg>`;
    }
  },

  flag: `<svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
    <path d="M5 3v18" stroke="currentColor" stroke-width="1.6" fill="none"/>
    <path d="M19 7s-3 0-5 1-4-1-6-1v8s3 1 6 0 5 1 5 1V7z" fill="currentColor"/>
  </svg>`,

  open: `<svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
    <path d="M14 3h7v7" stroke="currentColor" stroke-width="1.6" fill="none"/>
    <path d="M10 14L21 3" stroke="currentColor" stroke-width="1.6" fill="none"/>
    <path d="M21 21H3V3" stroke="currentColor" stroke-width="1.2" fill="none"/>
  </svg>`
};


/* Render a single post card DOM element */
function createPostCard({ postId, editorEmail, displayName, profilePic, verified, text, images, likedBy }, currentUserEmail){
  const userLiked = currentUserEmail ? likedBy.map(e=>String(e).toLowerCase()).includes(currentUserEmail) : false;
  const likeCount = likedBy.length || 0;

  const card = document.createElement('article');
  card.className = 'post-card';
  card.id = `post-${postId}`;

  // header
  const avatarUrl = profilePic || '/org-owner.jpg';
  const verifiedHtml = verified ? `<span class="verified-badge" title="Verified"></span>` : '';

  card.innerHTML = `
    <div class="author-row">
      <div class="author-left">
        <div class="avatar" style="background-image:url('${encodeURI(avatarUrl)}');" title="${escapeHtml(displayName)}"></div>
        <div class="author-meta">
          <div class="display-name">${escapeHtml(displayName)} ${verifiedHtml}</div>
          <div class="email-text">${escapeHtml(editorEmail)}</div>
        </div>
      </div>
    </div>

    <div class="post-text" role="article">${escapeHtml(text)}</div>
    ${ images && images.length ? `<div class="post-images">${images.map(u => `<img src="${encodeURI(u)}" loading="lazy" alt="post image" />`).join('')}</div>` : '' }

    <div class="sep" aria-hidden="true"></div>

    <div class="actions-row">
      <button class="icon-btn like-btn ${userLiked ? 'liked' : ''}" aria-pressed="${userLiked}" title="${userLiked ? 'Unlike' : 'Like'}">
        ${ICONS.heart(userLiked)} <span class="like-count">${likeCount}</span>
      </button>

      <button class="icon-btn report-btn" title="Report">
        ${ICONS.flag} <span class="muted" style="font-size:13px">Report</span>
      </button>

      <button class="icon-btn open-btn" title="Open post">
        ${ICONS.open} <span class="muted" style="font-size:13px">Open</span>
      </button>
    </div>
  `;

  return card;
}

/* Escape helper for attributes/text inserted as textContent */
function escapeHtml (unsafe) {
  return String(unsafe || '').replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; });
}

/* main: load posts */
const postsListEl = document.getElementById('postsList');

auth.onAuthStateChanged(async user => {
  postsListEl.innerHTML = ''; // clear
  const currentUserEmail = user?.email?.toLowerCase?.() || null;

  try{
    const snapshot = await db.collection('posts').orderBy('timestamp','desc').get();
    if(snapshot.empty){
      postsListEl.innerHTML = `<div class="muted" style="padding:18px; text-align:center">No posts yet.</div>`;
      return;
    }

    for(const doc of snapshot.docs){
      const postData = doc.data();
      const postId = doc.id;
      const editorEmailRaw = postData.editor || '';
      const editorEmail = String(editorEmailRaw).toLowerCase();

      if(!editorEmail) continue;

      // attempt to fetch author data robustly
      const userDocSnapshot = await (async ()=>{
        try{
          let snap = await db.collection('user_data').doc(editorEmail).get();
          if(snap.exists) return snap;
          snap = await db.collection('user_data').doc(encodeURIComponent(editorEmail)).get();
          if(snap.exists) return snap;
          const q = await db.collection('user_data').where('email','==', editorEmail).limit(1).get();
          if(!q.empty) return q.docs[0];
          return null;
        }catch(e){
          console.warn('author fetch error', e);
          return null;
        }
      })();

      // derive author info with fallbacks
      let displayName = editorEmail;
      let profilePic = '/org-owner.jpg';
      let verified = false;
      let blockedUsers = [];
      let frameUrl = '';

      if(userDocSnapshot && userDocSnapshot.exists){
        const ud = userDocSnapshot.data();
        displayName = ud['display name'] || ud.displayName || ud.name || editorEmail;
        profilePic = ud.profile_picture || ud.avatar || '/org-owner.jpg';
        verified = !!ud.is_verified || !!ud.verified;
        blockedUsers = Array.isArray(ud.blockedUsers) ? ud.blockedUsers.map(x=>String(x).toLowerCase()) : [];
        frameUrl = ud.profile_picture_frame || '';
      }

      // respect block lists: if author blocked current user, skip
      if(currentUserEmail && blockedUsers.includes(currentUserEmail)) continue;

      // prepare post properties
      const text = postData.text || '';
      const images = Array.isArray(postData.images) ? postData.images : [];
      const likedBy = Array.isArray(postData.likedBy) ? postData.likedBy : [];

      // create card
      const card = createPostCard({ postId, editorEmail, displayName, profilePic, verified, text, images, likedBy }, currentUserEmail);
      postsListEl.appendChild(card);

      // frame overlay if provided
      if(frameUrl){
        const avatarEl = card.querySelector('.avatar');
        const frameEl = document.createElement('div');
        frameEl.className = 'profile-pic-frame';
        frameEl.style.cssText = `position:absolute; left:0; top:0; width:56px; height:56px; border-radius:50%; background-image:url('${encodeURI(frameUrl)}'); background-size:cover; background-position:center; pointer-events:none;`;
        avatarEl.style.position = 'relative';
        avatarEl.appendChild(frameEl);
      }

      // wire actions
      const likeBtn = card.querySelector('.like-btn');
      const likeCountEl = card.querySelector('.like-count');
      const reportBtn = card.querySelector('.report-btn');
      const openBtn = card.querySelector('.open-btn');

      // Like handler (atomic update)
      likeBtn.addEventListener('click', async ()=>{
        if(!currentUserEmail){
          alert('You must sign in to like posts.');
          return;
        }
        likeBtn.disabled = true;
        const postRef = db.collection('posts').doc(postId);
        try{
          const already = likeBtn.classList.contains('liked');
          if(already){
            await postRef.update({ likedBy: firebase.firestore.FieldValue.arrayRemove(currentUserEmail) });
            likeBtn.classList.remove('liked');
            likeBtn.setAttribute('aria-pressed','false');
            // update count locally (decrement)
            let n = Math.max(0, Number(likeCountEl.textContent || 0) - 1);
            likeCountEl.textContent = n;
          } else {
            await postRef.update({ likedBy: firebase.firestore.FieldValue.arrayUnion(currentUserEmail) });
            likeBtn.classList.add('liked');
            likeBtn.setAttribute('aria-pressed','true');
            let n = Math.max(0, Number(likeCountEl.textContent || 0) + 1);
            likeCountEl.textContent = n;
          }
        }catch(err){
          console.error('like failed', err);
          alert('Could not update like. Try again.');
        }finally{
          likeBtn.disabled = false;
        }
      });

      // Report handler
      reportBtn.addEventListener('click', ()=>{
        // navigate to report page with reporting param
        window.location.href = `/reportabuse?reporting=${encodeURIComponent(editorEmail)}`;
      });

      // Open handler
      openBtn.addEventListener('click', ()=>{
        window.location.href = `/posts?post=${encodeURIComponent(postId)}`;
      });

    } // end for each post

  }catch(err){
    console.error('load posts failed', err);
    postsListEl.innerHTML = `<div class="muted" style="padding:18px; text-align:center; color:#ff6b6b">Error loading posts.</div>`;
  }
});
</script>
</body>
</html>
