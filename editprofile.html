<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Edit Profile</title>

  <!-- Firebase compat (works with other pages that use compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#171717;
      --card:#1f1f1f;
      --muted:#9ca3af;
      --accent:#6b21a8;
      --accent-strong:#5b21b6;
      --text:#eaeaea;
      --border:rgba(255,255,255,0.06);
    }
    body.light{
      --bg:#f6f8fb; --card:#fff; --muted:#475569; --text:#0f172a; --border:rgba(0,0,0,0.06);
    }

    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;box-sizing:border-box;overflow-x:hidden;}
    body{display:flex;flex-direction:column;min-height:100vh;}

    /* topbar (reuses dp-topbar webcomponent) */
    dp-topbar{display:block;position:sticky;top:0;z-index:100;}

    main.container{max-width:1100px;margin:22px auto;padding:20px;display:grid;grid-template-columns:1fr 320px;gap:20px;box-sizing:border-box;}
    @media (max-width:920px){ main.container{grid-template-columns:1fr;padding:16px 12px;} }

    .card{background:var(--card);border-radius:12px;padding:18px;border:1px solid var(--border);box-shadow:0 6px 18px rgba(2,6,23,0.45);color:var(--text);}

    /* header */
    .heading { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
    .title { font-size:18px; font-weight:700; margin:0; }
    .subtitle { color:var(--muted); font-size:13px; margin-top:6px; }

    /* profile area */
    .banner { width:100%; height:160px; border-radius:10px; background:#2a2a2a center/cover no-repeat; cursor:pointer; display:block; border:1px solid var(--border); }
    .profile-row { display:flex; gap:18px; align-items:flex-start; margin-top:14px; flex-wrap:wrap; }
    .pfp-wrap { position:relative; width:120px; flex:0 0 120px; }
    .pfp { width:120px; height:120px;   background-repeat: no-repeat; /* <-- add this */
border-radius:14px; background-size:cover; background-position:center; border:1px solid var(--border); }
    .pfp-frame { position:absolute; inset:0; border-radius:14px; pointer-events:none; display:none; }

    .meta { flex:1; min-width:220px; }
    .display-name { font-size:20px; font-weight:700; display:flex; gap:8px; align-items:center; }
    .verified { width:18px; height:18px; background-image:url('/assets/verified.png'); background-size:contain; background-repeat:no-repeat; display:inline-block; }
    .email { color:var(--muted); font-size:13px; margin-top:6px; }
    .bio { margin-top:12px; color:var(--text); line-height:1.4; }
    .small-muted { color:var(--muted); font-size:13px; margin-top:8px; }

    /* controls */
    .controls { margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; }
    .btn { padding:8px 12px; border-radius:8px; border:1px solid var(--border); background:transparent; color:var(--text); cursor:pointer; font-weight:600; }
    .btn.primary { background:var(--accent); color:#fff; border:none; }
    .btn.ghost { background:transparent; }
    .field-row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:8px; }

    input[type="text"], textarea { width:100%; padding:10px 12px; border-radius:8px; border:1px solid var(--border); background:transparent; color:var(--text); box-sizing:border-box; font-size:14px; }
    textarea { min-height:84px; resize:vertical; }

    .right-column .card + .card { margin-top:12px; }

    .list { display:flex; flex-direction:column; gap:8px; margin-top:8px; }

    .muted { color:var(--muted); }

    /* file area */
    .file-group { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px; }
    .file-input { display:none; }
    .upload-box { padding:10px 12px; border-radius:8px; border:1px dashed var(--border); background:rgba(255,255,255,0.01); cursor:pointer; color:var(--muted); font-size:13px; min-width:180px; text-align:center; }

    #toast { position:fixed; top:18px; left:50%; transform:translateX(-50%); padding:10px 14px; border-radius:10px; font-weight:700; display:none; z-index:99999; color:#fff; }
    #toast.purple{ background:var(--accent-strong); } #toast.red{ background:#c00; } #toast.yellow{ background:#e6b800; color:#222; }

    /* small responsive tweaks */
    @media (max-width:560px){
      .pfp{ width:96px; height:96px; border-radius:12px; }
      .pfp-wrap{ flex:0 0 96px; }
    }
  </style>
</head>
<body>
  <!-- topbar -->
  <script type="module" src="/dp-topbar.js"></script>
  <dp-topbar></dp-topbar>

  <main class="container" role="main" aria-label="Edit profile">
    <section class="card">
      <div class="heading">
        <div>
          <div class="title">Edit profile</div>
          <div class="subtitle">Update display name, bio, pictures and public settings</div>
        </div>
        <div class="muted" id="last-updated">Updated: —</div>
      </div>

      <div id="banner" class="banner" title="Click to upload banner"></div>

      <div class="profile-row">
        <div class="pfp-wrap">
          <div id="profile-pic" class="pfp" title="Click to upload profile picture"></div>
          <div id="pfp-frame" class="pfp-frame"></div>
        </div>

        <div class="meta">
          <div class="display-name">
            <div id="display-name">Loading…</div>
            <div id="verified" class="verified" title="Verified" style="display:none;"></div>
          </div>
          <div id="email" class="email"></div>

          <div class="bio">
            <strong>Bio</strong>
            <div id="bio-text" style="margin-top:8px;">Loading…</div>
          </div>

          <div class="field-row">
            <input id="displayNameInput" type="text" placeholder="Display name" aria-label="Display name">
            <button id="saveNameBtn" class="btn primary">Save</button>
          </div>

          <div class="field-row">
            <textarea id="bioInput" placeholder="Short bio (max 250 chars)"></textarea>
            <button id="saveBioBtn" class="btn primary">Save Bio</button>
          </div>

          <div class="small-muted">Public profile: <input id="publicCheckbox" type="checkbox" style="margin-left:8px"></div>

          <div class="controls">
            <button id="openPublicBtn" class="btn">View public profile</button>
            <button id="blockedUsersBtn" class="btn">Manage Blocked Users</button>
          </div>

          <div class="small-muted" style="margin-top:10px">Roles & info:</div>
          <div id="rolesList" class="list"></div>
        </div>
      </div>

    </section>

    <aside class="right-column">
      <div class="card">
        <div style="font-weight:700">Uploads</div>
        <div class="small-muted">PNG only. Files are uploaded to <code>catbox.moe</code> and the returned URL is saved to your profile.</div>

        <div style="margin-top:10px;">
          <label class="upload-box" id="uploadProfileBtn">Upload profile picture (PNG)</label>
          <input id="fileProfile" class="file-input" type="file" accept="image/png">
        </div>

        <div style="margin-top:8px;">
          <label class="upload-box" id="uploadBannerBtn">Upload banner (PNG)</label>
          <input id="fileBanner" class="file-input" type="file" accept="image/png">
        </div>

        <div style="margin-top:8px;">
          <label class="upload-box" id="uploadFrameBtn">Upload profile frame (PNG)</label>
          <input id="fileFrame" class="file-input" type="file" accept="image/png">
        </div>

        <div id="fallbackRow" style="margin-top:10px; display:none;">
          <div class="small-muted">Fallback URL</div>
          <input id="fallbackUrlInput" type="text" placeholder="https://example.com/pic.png">
          <div style="display:flex; gap:8px; margin-top:8px;">
            <button id="saveFallbackProfile" class="btn">Save Profile URL</button>
            <button id="saveFallbackBanner" class="btn">Save Banner URL</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:700">Account Actions</div>
        <div style="margin-top:8px; display:flex; gap:8px; flex-direction:column;">
          <button id="downloadProfileJson" class="btn">Export profile JSON</button>
          <button id="deleteFrameBtn" class="btn">Remove frame</button>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:700">Help</div>
        <div class="small-muted" style="margin-top:8px">
          • Uploads are PNG only. <br>
          • Catbox URLs are saved to Firestore (user_data collection).<br>
          • If fallback URL input is visible, you can paste a URL instead of uploading.
          • CORS might disallow uploads from some browsers.<br>
        </div>
      </div>
    </aside>
  </main>

  <div id="toast" role="status" aria-live="polite"></div>

  <script>
    // Firebase init (compat)
    const firebaseConfig = {
      apiKey: "AIzaSyCAPZF2zwU6z5rhikrIVZ4TVxf1tS5aTbA",
      authDomain: "darkpurpleof-s-website.firebaseapp.com",
      projectId: "darkpurpleof-s-website",
      storageBucket: "darkpurpleof-s-website.firebasestorage.app",
      messagingSenderId: "520651082420",
      appId: "1:520651082420:web:bb05c0c3fd64517952e5e1"
    };
    if (!window.firebase || !firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM
    const bannerEl = document.getElementById('banner');
    const profilePicEl = document.getElementById('profile-pic');
    const pfpFrameEl = document.getElementById('pfp-frame');
    const displayNameEl = document.getElementById('display-name');
    const emailEl = document.getElementById('email');
    const verifiedEl = document.getElementById('verified');
    const bioTextEl = document.getElementById('bio-text');
    const rolesList = document.getElementById('rolesList');
    const openPublicBtn = document.getElementById('openPublicBtn');
    const blockedUsersBtn = document.getElementById('blockedUsersBtn');

    const displayNameInput = document.getElementById('displayNameInput');
    const saveNameBtn = document.getElementById('saveNameBtn');
    const bioInput = document.getElementById('bioInput');
    const saveBioBtn = document.getElementById('saveBioBtn');
    const publicCheckbox = document.getElementById('publicCheckbox');

    const uploadProfileBtn = document.getElementById('uploadProfileBtn');
    const fileProfile = document.getElementById('fileProfile');
    const uploadBannerBtn = document.getElementById('uploadBannerBtn');
    const fileBanner = document.getElementById('fileBanner');
    const uploadFrameBtn = document.getElementById('uploadFrameBtn');
    const fileFrame = document.getElementById('fileFrame');

    const fallbackRow = document.getElementById('fallbackRow');
    const fallbackUrlInput = document.getElementById('fallbackUrlInput');
    const saveFallbackProfile = document.getElementById('saveFallbackProfile');
    const saveFallbackBanner = document.getElementById('saveFallbackBanner');

    const downloadProfileJson = document.getElementById('downloadProfileJson');
    const deleteFrameBtn = document.getElementById('deleteFrameBtn');

    const toastEl = document.getElementById('toast');
    function showToast(msg, color='purple', duration=3000){ toastEl.textContent = msg; toastEl.className = color; toastEl.style.display='block'; setTimeout(()=>{ toastEl.style.display='none'; toastEl.className=''; }, duration); }

    // Catbox upload helper (PNG only)
    async function uploadToCatbox(file) {
      if (!file) throw new Error('No file provided');
      if (file.type !== 'image/png') throw new Error('Only PNG files are allowed');
      const fd = new FormData();
      fd.append('reqtype','fileupload');
      fd.append('userhash',''); // optional; leave empty
      fd.append('fileToUpload', file);
      // Catbox API endpoint:
      const res = await fetch('https://catbox.moe/user/api.php', { method:'POST', body: fd });
      if (!res.ok) throw new Error('Upload failed with status ' + res.status);
      const text = await res.text();
      // response is the raw URL (or error)
      if (!text || !text.startsWith('http')) throw new Error('Upload failed: ' + text);
      return text.trim();
    }

    // save to Firestore helper
    async function saveUserField(email, field, value) {
      const ref = db.collection('user_data').doc(email);
      const obj = {}; obj[field] = value;
      await ref.set(obj, { merge: true });
    }

    // Bind click labels to file inputs
    uploadProfileBtn.addEventListener('click', () => fileProfile.click());
    uploadBannerBtn.addEventListener('click', () => fileBanner.click());
    uploadFrameBtn.addEventListener('click', () => fileFrame.click());

    // File change handlers
    fileProfile.addEventListener('change', async (e) => {
      const f = e.target.files[0]; if (!f) return;
      await handleUploadFile('profile_picture', f);
      e.target.value = '';
    });
    fileBanner.addEventListener('change', async (e) => {
      const f = e.target.files[0]; if (!f) return;
      await handleUploadFile('banner', f);
      e.target.value = '';
    });
    fileFrame.addEventListener('change', async (e) => {
      const f = e.target.files[0]; if (!f) return;
      await handleUploadFile('profile_picture_frame', f);
      e.target.value = '';
    });

    // Generic file upload flow
 async function handleUploadFile(fieldName, file) {
  if (!currentUser) return showToast('Not signed in', 'yellow');

  let corsTimeoutTriggered = false;

  // start a 3-second timer for fast CORS detection
  const corsTimeout = setTimeout(() => {
    corsTimeoutTriggered = true;
    showToast('CORS blocked upload — use a URL instead', 'yellow', 5000);
    fallbackRow.style.display = 'block'; // show fallback input automatically
  }, 3000);

  try {
    showToast('Uploading to catbox.moe — this may take a moment...', 'purple', 10000);

    const url = await uploadToCatbox(file); // attempt normal upload
    clearTimeout(corsTimeout);

    // if CORS toast already shown, just update UI anyway
    if (!corsTimeoutTriggered) {
      // update UI normally
      if (fieldName === 'profile_picture') profilePicEl.style.backgroundImage = `url(${url})`;
      else if (fieldName === 'banner') bannerEl.style.backgroundImage = `url(${url})`;
      else if (fieldName === 'profile_picture_frame') {
        pfpFrameEl.style.backgroundImage = `url(${url})`;
        pfpFrameEl.style.display = 'block';
      }
      await saveUserField(currentUser.email, fieldName, url);
      showToast('Uploaded and saved!', 'purple', 2500);
    } else {
      // still save the file in Firestore even if CORS toast showed
      await saveUserField(currentUser.email, fieldName, url);
      if (fieldName === 'profile_picture') profilePicEl.style.backgroundImage = `url(${url})`;
      else if (fieldName === 'banner') bannerEl.style.backgroundImage = `url(${url})`;
      else if (fieldName === 'profile_picture_frame') {
        pfpFrameEl.style.backgroundImage = `url(${url})`;
        pfpFrameEl.style.display = 'block';
      }
      showToast('Upload finished!', 'purple', 2500);
    }
  } catch (err) {
    clearTimeout(corsTimeout);
    console.error('upload error', err);

    // normal CORS/network detection
    if (err.message.includes('Failed to fetch') || err.message.includes('NetworkError')) {
      showToast('CORS blocked upload — use a URL instead', 'yellow', 5000);
      fallbackRow.style.display = 'block';
    } else {
      showToast('Upload failed: ' + (err?.message || err), 'red', 5000);
    }
  }
}


    // Fallback URL save (when localStorage flag enabled)
    saveFallbackProfile.addEventListener('click', async () => {
      if (!currentUser) return showToast('Not signed in', 'yellow');
      const url = (fallbackUrlInput.value || '').trim();
      if (!url) return showToast('Enter a URL', 'yellow');
      try {
        await saveUserField(currentUser.email, 'profile_picture', url);
        profilePicEl.style.backgroundImage = `url(${url})`;
        showToast('Profile picture URL saved', 'purple');
      } catch (e) { showToast('Failed to save URL', 'red'); }
    });
    saveFallbackBanner.addEventListener('click', async () => {
      if (!currentUser) return showToast('Not signed in', 'yellow');
      const url = (fallbackUrlInput.value || '').trim();
      if (!url) return showToast('Enter a URL', 'yellow');
      try {
        await saveUserField(currentUser.email, 'banner', url);
        bannerEl.style.backgroundImage = `url(${url})`;
        showToast('Banner URL saved', 'purple');
      } catch (e) { showToast('Failed to save URL', 'red'); }
    });

    // Delete frame
    deleteFrameBtn.addEventListener('click', async () => {
      if (!currentUser) return showToast('Not signed in', 'yellow');
      if (!confirm('Remove your profile frame?')) return;
      try {
        await saveUserField(currentUser.email, 'profile_picture_frame', '');
        pfpFrameEl.style.display = 'none';
        pfpFrameEl.style.backgroundImage = '';
        showToast('Frame removed', 'purple');
      } catch (e) { showToast('Failed to remove frame', 'red'); }
    });

    // Save display name
    saveNameBtn.addEventListener('click', async () => {
      if (!currentUser) return showToast('Not signed in', 'yellow');
      const v = (displayNameInput.value||'').trim();
      if (!v) return showToast('Enter a display name', 'yellow');
      try { await saveUserField(currentUser.email, 'display name', v); displayNameEl.textContent = v; showToast('Saved', 'purple'); } catch (e){ showToast('Failed to save', 'red'); }
    });

    // Save bio
    saveBioBtn.addEventListener('click', async () => {
      if (!currentUser) return showToast('Not signed in', 'yellow');
      const v = (bioInput.value||'').trim();
      if (v.length > 250) return showToast('Bio too long (max 250 chars)', 'yellow');
      try { await saveUserField(currentUser.email, 'bio', v); bioTextEl.textContent = v || 'Bio not yet set'; showToast('Saved', 'purple'); } catch (e){ showToast('Failed to save', 'red'); }
    });

    // Public profile toggle
    publicCheckbox.addEventListener('change', async () => {
      if (!currentUser) return showToast('Not signed in', 'yellow');
      try { await saveUserField(currentUser.email, 'isProfilePublic', publicCheckbox.checked); showToast('Saved', 'purple'); } catch (e){ showToast('Failed', 'red'); publicCheckbox.checked = !publicCheckbox.checked; }
    });

    // Download JSON
    downloadProfileJson.addEventListener('click', async () => {
      if (!currentUser) return showToast('Not signed in', 'yellow');
      try {
        const snap = await db.collection('user_data').doc(currentUser.email).get();
        const data = snap.exists ? snap.data() : {};
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'profile.json'; a.click(); URL.revokeObjectURL(url);
        showToast('Downloaded', 'purple');
      } catch (e) { showToast('Failed to export', 'red'); }
    });

    // navigation
    openPublicBtn.addEventListener('click', () => { if (currentUser) window.location.href = `/viewprofile?profile=${encodeURIComponent(currentUser.email)}`; });
    blockedUsersBtn.addEventListener('click', () => window.location.href = '/manageblockedusers');

    // show fallback input if localStorage boolean set
    if (localStorage.getItem('useFallbackUrl') === 'true') fallbackRow.style.display = 'block';

    // Load user info
    let currentUser = null;
    auth.onAuthStateChanged(async (u) => {
      if (!u) { window.location.href = '/login'; return; }
      currentUser = u;
      emailEl.textContent = u.email;
      await loadProfileFor(u.email);
    });

    async function loadProfileFor(email) {
      try {
        const snap = await db.collection('user_data').doc(email).get();
        const data = snap.exists ? snap.data() : {};
        const banner = data.banner || '/assets/default_banner.png';
        const pfp = data.profile_picture || 'https://darkpurpleof.github.io/org-owner.jpg';
        const display = data['display name'] || email;
        const bio = data.bio || 'Bio not yet set';
        const isVerified = !!data.is_verified;
        const frame = data.profile_picture_frame || '';

        bannerEl.style.backgroundImage = `url(${banner})`;
        profilePicEl.style.backgroundImage = `url(${pfp})`;
        displayNameEl.textContent = display;
        displayNameInput.value = display;
        bioTextEl.textContent = bio;
        bioInput.value = data.bio || '';
        publicCheckbox.checked = !!data.isProfilePublic;
        emailEl.textContent = email;
        verifiedEl.style.display = isVerified ? 'inline-block' : 'none';
        if (frame) { pfpFrameEl.style.backgroundImage = `url(${frame})`; pfpFrameEl.style.display = 'block'; } else { pfpFrameEl.style.display = 'none'; }

        // roles
        rolesList.innerHTML = '';
        const roles = Array.isArray(data.roles) ? data.roles : (data.role ? [data.role] : ['Member']);
        roles.forEach(r => {
          const el = document.createElement('div');
          el.className = 'muted';
          el.textContent = r;
          rolesList.appendChild(el);
        });

        // last updated: attempt to use a timestamp field if present
        if (data.last_updated) {
          const d = new Date(data.last_updated.seconds ? data.last_updated.seconds * 1000 : data.last_updated);
          document.getElementById('last-updated').textContent = 'Updated: ' + d.toLocaleString();
        } else document.getElementById('last-updated').textContent = '';

      } catch (err) {
        console.error('load profile', err);
        showToast('Failed to load profile', 'red');
      }
    }

    // small accessibility: allow clicking on banner/pfp frame to trigger file input
    bannerEl.addEventListener('click', () => fileBanner.click());
    profilePicEl.addEventListener('click', () => fileProfile.click());

    // ensure px overflow prevented
    window.addEventListener('resize', () => { document.documentElement.style.overflowX = 'hidden'; });
  </script>
</body>
</html>
