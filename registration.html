<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Register</title>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>

  <!-- reCAPTCHA -->
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #171717;
      --card: #1f1f1f;
      --muted: #a8a8a8;
      --accent: #6b21a8;
      --accent-strong: #5b21b6;
      --text: #eaeaea;
      --border: rgba(255,255,255,0.04);
    }
    body.light {
      --bg: #f6f8fb;
      --card:#fff;
      --muted:#475569;
      --text:#0f172a;
      --border: rgba(0,0,0,0.06);
    }

    html,body { height:100%; margin:0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background-color: var(--bg); color:var(--text); transition: background .25s, color .25s; }
    body { display:flex; flex-direction:column; min-height:100vh; }

    /* dp-topbar */
    dp-topbar { display:block; position:sticky; top:0; z-index:100; }

    /* main wrapper centers content */
    main.wrapper {
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      box-sizing:border-box;
    }

    .card {
      background:var(--card);
      border-radius:12px;
      padding:24px;
      border:1px solid var(--border);
      color:var(--text);
      box-shadow:0 6px 18px rgba(2,6,23,0.45);
      max-width:640px;
      width:100%;
    }

    .grid {
      display:grid;
      grid-template-columns: 1fr 320px;
      gap:20px;
    }
    @media (max-width:920px){
      .grid { grid-template-columns: 1fr; }
    }

    h1 { margin:0 0 6px 0; font-size:20px; font-weight:700; }
    p.lead { margin:0 0 16px 0; color:var(--muted); font-size:14px; }

    .info-chart {
      background: var(--card);
      border-radius:10px;
      padding:12px;
      border:1px solid var(--border);
    }

    form { display:flex; flex-direction:column; gap:12px; }
    .input { width:100%; padding:12px; border-radius:8px; border:1px solid var(--border); background:var(--card); color:var(--text); box-sizing:border-box; }
    label { font-size:13px; color:var(--muted); display:block; margin-bottom:6px; }

    .row { display:flex; gap:12px; }
    .row .col { flex:1; }

    .register-button {
      background:var(--accent);
      color:#fff;
      border:none;
      padding:12px;
      border-radius:8px;
      font-weight:700;
      cursor:pointer;
    }
    .register-button:hover { opacity:0.95; }

    .small-note { font-size:13px; color:var(--muted); }

    /* toast (matches /home) */
    #toast {
      position: fixed;
      top: 18px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 700;
      display: none;
      z-index: 99999;
      color: #fff;
      box-sizing: border-box;
    }
    #toast.purple { background: var(--accent-strong); color:#fff; }
    #toast.yellow { background: #e6b800; color:#222; }
    #toast.red { background: #c00; color:#fff; }

    /* subtle helper */
    .muted { color:var(--muted); }

    @media (max-width:600px){
      main.wrapper { padding:16px; }
      .card { padding:16px; }
      .grid { grid-template-columns: 1fr; }
    }
  </style>

  <!-- dp-topbar -->
  <script type="module" src="/dp-topbar.js"></script>
</head>
<body>
  <dp-topbar></dp-topbar>

  <main class="wrapper" role="main" aria-label="Register area">
    <div class="card" role="region" aria-label="Register form">
      <div class="grid">
        <!-- LEFT: form -->
        <div>
          <h1>Create an account</h1>
          <p class="lead">Join the platform. All admin accounts are reserved and cannot be registered here.</p>

          <form id="registerForm" autocomplete="on" novalidate>
            <div>
              <label for="email">Email</label>
              <input id="email" class="input" type="email" inputmode="email" placeholder="you@example.com" required>
            </div>

            <div>
              <label for="password">Password</label>
              <input id="password" class="input" type="password" placeholder="Choose a strong password" required>
            </div>

            <!-- reCAPTCHA widget (user must complete) -->
            <div style="margin-top:6px;">
              <div class="muted" style="margin-bottom:6px; font-size:13px;">Please complete the reCAPTCHA</div>
              <div class="g-recaptcha" data-sitekey="6Lddwd8qAAAAAC0OUZ7iOrKFGEeu--_-1XvjU0et"></div>
            </div>

            <div>
              <button type="submit" class="register-button">Register</button>
            </div>

            <div class="small-note" style="margin-top:8px;">
              By registering you agree to our <a href="/terms.md" style="color:var(--accent); text-decoration:none;">Terms of Service</a>.
            </div>

            <div class="small-note" style="margin-top:6px;">
              <strong>@darkpurpleof.github.io</strong> addresses cannot be registered here.
            </div>
          </form>
        </div>

        <!-- RIGHT: info / hints -->
        <aside class="info-chart" aria-hidden="false">
          <h3 style="margin:0 0 8px 0">Why verify?</h3>
          <p class="muted" style="margin:0 0 12px 0;">We check IP & email bans, region, and reCAPTCHA to keep the community safe.</p>

          <div style="display:flex; gap:8px; flex-direction:column;">
            <div class="muted">Registration checks:</div>
            <ul class="muted" style="margin:6px 0 0 18px; padding:0;">
              <li>reCAPTCHA completion</li>
              <li>No reserved @darkpurpleof.github.io signups</li>
              <li>IP & email ban checks</li>
              <li>Region & VPN detection</li>
            </ul>
          </div>

          <div style="height:12px;"></div>
          <div><a href="/login.html" style="color:var(--accent); text-decoration:none;">Already have an account? Login</a></div>
        </aside>
      </div>
    </div>
  </main>

  <div id="toast" role="status" aria-live="polite"></div>

  <script>
    // ensure firebase compat is initialized
    const firebaseConfig = {
      apiKey: "AIzaSyCAPZF2zwU6z5rhikrIVZ4TVxf1tS5aTbA",
      authDomain: "darkpurpleof-s-website.firebaseapp.com",
      projectId: "darkpurpleof-s-website",
      storageBucket: "darkpurpleof-s-website.firebasestorage.app",
      messagingSenderId: "520651082420",
      appId: "1:520651082420:web:bb05c0c3fd64517952e5e1"
    };
    if (!window.firebase || !firebase.apps.length) firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.firestore();

    // Toast helper (consistent with /home)
    function showToast(message, color = "purple", duration = 3500) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.className = color + " show";
      toast.style.display = "block";
      setTimeout(() => {
        toast.className = color + " hide";
        setTimeout(() => {
          toast.style.display = "none";
          toast.className = "";
        }, 400);
      }, duration);
    }

    // onAuthStateChanged: if already signed in redirect (and check bans)
    auth.onAuthStateChanged(async (user) => {
      if (!user) return;
      const email = user.email || "";
      try {
        const bannedSnap = await db.collection("banned_users").doc(email).get();
        if (bannedSnap.exists) {
          window.location.href = "/not-approved";
          return;
        }
      } catch (e) {
        console.warn("Failed banned check on auth state:", e);
      }
      window.location.href = "/";
    });

    // fetch IP info (ipinfo). If you have a token, append ?token=...
    async function fetchUserIpInfo() {
      try {
        const r = await fetch("https://ipinfo.io/json");
        if (!r.ok) return null;
        return await r.json();
      } catch (e) {
        console.warn("fetchUserIpInfo failed", e);
        return null;
      }
    }

    async function checkBans(email, userIp) {
      try {
        const [emailDoc, ipDoc] = await Promise.all([
          db.collection("banned_users").doc(email).get(),
          db.collection("banned_ips").doc(userIp).get()
        ]);
        return (emailDoc.exists || ipDoc.exists);
      } catch (e) {
        console.warn("checkBans error", e);
        return false; // fail open-ish (we also notify)
      }
    }

    const bannedRegions = ["United Kingdom","Australia","Turkiye","Turkey","Argentina","Brazil","China"];

    document.getElementById("registerForm").addEventListener("submit", async (ev) => {
      ev.preventDefault();
      const email = (document.getElementById("email").value || "").trim().toLowerCase();
      const password = document.getElementById("password").value || "";

      if (!email || !password) { showToast("Email and password are required.", "yellow"); return; }
      if (email.endsWith("@darkpurpleof.github.io")) {
        showToast("You can't register an admin address here. Ask the owner.", "red");
        return;
      }

      // reCAPTCHA
      try {
        const token = (typeof grecaptcha !== "undefined") ? grecaptcha.getResponse() : "";
        if (!token) { showToast("Please complete the reCAPTCHA.", "red"); return; }
      } catch (e) {
        showToast("reCAPTCHA unavailable. Try again later.", "red");
        return;
      }

      showToast("Checking registration details...", "purple", 1500);

      // IP & region checks
      const ipInfo = await fetchUserIpInfo();
      if (!ipInfo) { showToast("Could not determine IP address.", "red"); return; }

      if (bannedRegions.includes(ipInfo.region)) {
        showToast("Registration from your region is not allowed.", "red"); return;
      }

      if (ipInfo.privacy && ipInfo.privacy.vpn) {
        showToast("VPN usage detected. Disable VPN to register.", "red"); return;
      }

      // check email/ip bans
      const isBanned = await checkBans(email, ipInfo.ip);
      if (isBanned) { showToast("Your email or IP is banned.", "red"); return; }

      // attempt create user (compat)
      try {
        await auth.createUserWithEmailAndPassword(email, password);
        showToast("Registration successful â€” redirecting...", "purple", 1800);
        setTimeout(() => window.location.href = "/", 1400);
      } catch (err) {
        console.warn("registration failed", err);
        // friendly message to user but log real error
        showToast(("Registration failed: " + (err && err.message ? err.message : "unknown")), "red");
      }
    });
  </script>
</body>
</html>
