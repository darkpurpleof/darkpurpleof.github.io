<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/shop.css">
  <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap');

        :root {
            --bg-color: #000;
            --text-color: purple;
            --box-bg: rgba(128, 0, 128, 0.05);
            --border-color: purple;
        }

        body.light {
            --bg-color: #fff;
            --text-color: purple;
            --box-bg: rgba(128, 0, 128, 0.1);
            --border-color: purple;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Orbitron', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            min-height: 100vh;
            transition: background 0.4s, color 0.4s;
            padding: 1rem;
            box-sizing: border-box;
        }

        .top-bar {
            width: 100%;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .icon-btn {
            font-size: 22px;
            cursor: pointer;
            background: transparent;
            border: none;
            color: var(--text-color);
            padding: 6px;
            transition: opacity 0.3s;
        }

        .icon-btn:hover {
            opacity: 0.7;
        }

        .profile-pic {
            width: 32px;
            height: 32px;
            background-color: var(--box-bg);
            border: 1.5px solid var(--border-color);
            border-radius: 50%;
            background-size: cover;
            background-position: center;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
            text-shadow: 0 0 6px var(--text-color);
            animation: glitch 1.5s infinite;
        }

        .info-chart {
            width: 240px;         /* Fixed width for all cards */
            height: 420px;        /* Increased height for all cards */
            margin: 20px auto;
            padding: 15px;
            background-color: var(--box-bg);
            border: 1.5px solid var(--border-color);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            text-align: left;
            transition: background-color 0.3s, border-color 0.3s;
            box-sizing: border-box;
            overflow: hidden;     /* Prevent overflow */
        }

        .info-chart p {
    max-height: 48px;           /* Limit height for description */
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    width: 100%;
    margin-bottom: 8px;
}

        .input-field {
            width: calc(100% - 2px); /* Take up almost all width minus padding */
            padding: 12px;
            margin: 10px 0;
            border: 1.5px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--box-bg);
            color: var(--text-color);
            box-sizing: border-box;
        }

        .register-button {
            width: calc(100% - 2px); /* Same as input field */
            background-color: var(--box-bg);
            color: var(--text-color);
            padding: 12px 20px;
            border: 1.5px solid var(--border-color);
            border-radius: 8px;
            font-size: 1.2em;
            cursor: pointer;
            margin-top: 10px;
        }

        .register-button:hover {
            opacity: 0.8;
        }

        .error-message {
            color: red;
            margin-top: 10px;
            font-size: 1em;
        }

        .success-message {
            color: purple;
            margin-top: 10px;
            font-size: 1em;
        }

        .dark-light-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 1.5em;
            color: var(--text-color);
            transition: color 0.3s;
        }

        .dark-mode .dark-light-toggle {
            color: var(--text-color);
        }

      dialog#confirm-dialog {
    border: 2px solid var(--border-color);
    border-radius: 16px;
    padding: 20px 30px;
    background: var(--bg-color);
    color: var(--text-color);
    box-shadow:
        0 0 20px rgba(128, 0, 128, 0.5),
        inset 0 0 10px rgba(128, 0, 128, 0.2); /* subtle inner glow */
    transition: opacity 0.4s ease, transform 0.4s ease;
    opacity: 0;
    transform: translateY(-20px);
    pointer-events: none;
    max-width: 90vw;
    width: 400px;
}

dialog[open]#confirm-dialog {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
}

#toast {
    position: fixed;
    top: -80px; /* Start hidden above the viewport */
    left: 0;
    width: 100vw;
    min-width: 0;
    max-width: 100vw;
    padding: 18px 0;
    border-radius: 0 0 16px 16px;
    font-size: 1.1em;
    font-family: inherit;
    color: #fff;
    z-index: 9999;
    box-shadow: 0 4px 16px rgba(128,0,128,0.15);
    opacity: 0;
    pointer-events: none;
    text-align: center;
    transition: opacity 0.4s, top 0.4s;
}
#toast.show {
    opacity: 1;
    pointer-events: auto;
    top: 0;
    animation: toast-slide-down 0.4s cubic-bezier(.77,0,.175,1);
}
#toast.hide {
    opacity: 0;
    top: -80px;
    animation: toast-slide-up 0.4s cubic-bezier(.77,0,.175,1);
}
#toast.purple { background: purple; }
#toast.yellow { background: #e6b800; color: #222; }
#toast.red { background: #c00; }

@keyframes toast-slide-down {
    from { top: -80px; opacity: 0; }
    to   { top: 0; opacity: 1; }
}
@keyframes toast-slide-up {
    from { top: 0; opacity: 1; }
    to   { top: -80px; opacity: 0; }
}

dialog::backdrop {
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(5px);
    transition: background 0.3s ease;
}

#confirm-dialog h3 {
    margin-top: 0;
    font-size: 1.5em;
    text-shadow: 0 0 4px var(--text-color);
}

#confirm-dialog menu {
    display: flex;
    justify-content: space-between;
    margin-top: 20px;
    gap: 10px;
}

#confirm-dialog button {
    flex: 1;
    padding: 10px 15px;
    font-family: inherit;
    font-size: 1em;
    border: 1.5px solid var(--border-color);
    background-color: var(--box-bg);
    color: var(--text-color);
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s, transform 0.2s ease;
}

#confirm-dialog button:hover {
    background-color: rgba(128, 0, 128, 0.2);
    transform: scale(1.05);
}

        @keyframes glitch {
            0% { transform: none; }
            20% { transform: skewX(3deg); }
            40% { transform: skewX(-3deg); }
            60% { transform: none; }
            100% { transform: none; }
        }

        .shop-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 24px;
    justify-content: center;
    width: 100%;
}
    </style>
</head>
<body class="dark">
    <div class="top-bar">
        <div id="coin-balance">DF$ - 0</div>
        <button class="icon-btn" id="theme-toggle">ðŸŒ™</button>
        <div id="profile" class="profile-pic" style="background-image: url('https://darkpurpleof.github.io/org-owner.jpg');"></div>
    </div>

    <h1>Shop</h1>

    <div id="shop-items" class="shop-grid"></div>

    <dialog id="confirm-dialog">
        <form method="dialog">
            <h3 id="confirm-title">Confirm Purchase</h3>
            <p id="confirm-text"></p>
            <menu>
                <button id="cancel-btn" value="cancel">Cancel</button>
                <button id="confirm-btn" value="default">Buy</button>
            </menu>
        </form>
    </dialog>

    <div id="toast" style="display:none;"></div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            updateDoc
        , setDoc, serverTimestamp, arrayUnion
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
const firebaseConfig = {
  apiKey: "AIzaSyCAPZF2zwU6z5rhikrIVZ4TVxf1tS5aTbA",
  authDomain: "darkpurpleof-s-website.firebaseapp.com",
  databaseURL: "https://darkpurpleof-s-website-default-rtdb.firebaseio.com",
  projectId: "darkpurpleof-s-website",
  storageBucket: "darkpurpleof-s-website.firebasestorage.app",
  messagingSenderId: "520651082420",
  appId: "1:520651082420:web:bb05c0c3fd64517952e5e1",
  measurementId: "G-S2X2JYC8Z0"
};

        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore();

        const coinDisplay = document.getElementById("coin-balance");
        const profile = document.getElementById("profile");
        const shopContainer = document.getElementById("shop-items");
        const dialog = document.getElementById("confirm-dialog");
        const confirmTitle = document.getElementById("confirm-title");
        const confirmText = document.getElementById("confirm-text");

        let currentUser = null;
        let currentCoins = "DF$ - 0";
        let selectedItem = null;

        function formatCoins(value) {
    const num = parseFloat(value);
    if (isNaN(num)) return "?";

    const suffixes = [
        { value: 1e18, symbol: "Qs" },
        { value: 1e15, symbol: "Qd" },
        { value: 1e12, symbol: "T" },
        { value: 1e9, symbol: "B" },
        { value: 1e6, symbol: "M" },
        { value: 1e3, symbol: "K" }
    ];

    for (let i = 0; i < suffixes.length; i++) {
        if (num >= suffixes[i].value) {
            return (num / suffixes[i].value).toFixed(1) + suffixes[i].symbol;
        }
    }

    return num.toString();
}

        async function updateUserData(user) {
    const email = user.email;
    const userDoc = doc(db, "user_data", email);
    try {
        const docSnap = await getDoc(userDoc);
        const data = docSnap.data();
        const coins = data?.coins ?? "DF$ - 0";
        const pic = data?.profile_picture ?? "https://darkpurpleof.github.io/org-owner.jpg";

        currentCoins = coins;
        coinDisplay.textContent = "DF$ - " + formatCoins(coins);  // Prepend "DF$ - "
        profile.style.backgroundImage = `url('${pic}')`;
    } catch (err) {
        currentCoins = "DF$ - ?";
        coinDisplay.textContent = "DF$ - 0";  // Prepend "DF$ - "
        profile.style.backgroundImage = `url('https://darkpurpleof.github.io/org-owner.jpg')`;
    }
}

        onAuthStateChanged(auth, user => {
            currentUser = user;
            if (user) {
                updateUserData(user);
            } else {
                profile.style.backgroundImage = "url('https://darkpurpleof.github.io/org-owner.jpg')";
                coinDisplay.textContent = "DF$ - 0";
                currentCoins = "DF$ - 0";
            }
        });

        const shopItems = [
    {
        productId: "COINPACKFREE1000",
        title: "Free Coins",
        description: "Get free 1000 coins for testing the preview",
        price: 0,
        image: "https://darkpurpleof.github.io/org-owner.jpg",
        author: "darkpurpleof@darkpurpleof.github.io",
        action: async () => {
            if (!currentUser) {
                showToast("You must be signed in to receive coins.", "red");
                return;
            }

            const email = currentUser.email;
            const userDoc = doc(db, "user_data", email);

            try {
                const docSnap = await getDoc(userDoc);
                const currentCoins = parseInt(docSnap.data()?.coins ?? "0");

                const newCoins = currentCoins + 1000;

                await updateDoc(userDoc, {
                    coins: newCoins.toString()
                });
                showToast("Coins added successfully!", "purple");
            } catch (e) {
                console.error("Failed to add coins:", e);
                showToast("An error occurred while adding coins.", "red");
            }
        }
    },
    {
        productId: "FURRYROLE",
        title: "Furry Role",
        description: "ooh, you like kissing boys, dont you?",
        price: 50,
        image: "https://media1.tenor.com/m/2hCfz7DcxcEAAAAd/boykisser-boykisser-meme.gif",
        author: "boykisser2189@darkpurpleof.github.io",
        action: async () => {
            if (!currentUser) {
                showToast("You must be signed in to update your roles.", "red");
                return;
            }

            const email = currentUser.email;
            const userDoc = doc(db, "user_data", email);

            try {
                await updateDoc(userDoc, {
                    roles: arrayUnion("Furry")
                });
                showToast("Role updated successfully!", "purple");
            } catch (e) {
                console.error("Failed to update roles:", e);
                showToast("An error occurred while updating roles.", "red");
            }
        }
    },
    {
        productId: "MESSAGELIMITNONE",
        title: "No message limit",
        description: "No longer be limited by the 300 character limit, get infinite character messages!",
        price: 300,
        image: "https://darkpurpleof.github.io/assets/360_F_1231361662_LFZiAQMDXEKfOvKIfNBQoXp9OVgIMaq2.webp",
        author: "darkpurpleof@darkpurpleof.github.io",
        action: async () => {
            // No action needed; ID is enough
        }
    },
    {
        productId: "CWALLPAPER",
        title: "Chat Wallpapers",
        description: "Save your chat wallpapers remotely instead of just locally!",
        price: 1000,
        image: "https://4kwallpapers.com/images/walls/thumbs_3t/8133.jpg",
        author: "superperro9705@darkpurpleof.github.io",
        action: async () => {
            // No action needed; ID is enough
        }
    },
    {
        productId: "USELESSBOYKISSER",
        title: "Yet another boykisser",
        description: "Who?",
        price: 1,
        image: "https://boykisser2189.neocities.org/boykisseridk.gif",
        author: "boykisser2189@darkpurpleof.github.io",
        action: () => {
            window.open("https://boykisser2189.neocities.org/boykisser", "_blank");
        }
    },
    {
        productId: "PFPFRAMES",
        title: "Profile Picture Frames",
        description: "Unlock the ability to use custom frames on your profile picture and stand out in the community!",
        price: 300,
        image: "https://boykisser2189.neocities.org/frames.jpg",
        author: "boykisser2189@darkpurpleof.github.io",
        action: async () => {
            // No action needed; ID is enough
        }
    }
];


        function renderShop() {
            shopItems.forEach(item => {
                const box = document.createElement("div");
                box.className = "info-chart";

                const img = document.createElement("img");
                img.src = item.image;
                img.style.width = "200px";  /* Fixed width */
img.style.height = "200px"; /* Fixed height */
img.style.objectFit = "cover"; /* Ensure image fits nicely within the box */
img.style.borderRadius = "10px"; /* Maintain rounded corners */


                const title = document.createElement("h3");
                title.textContent = item.title;

                const desc = document.createElement("p");
                desc.className = "item-desc";
                desc.textContent = item.description;

                const price = document.createElement("p");
                price.innerHTML = `<b>Price:</b> ${formatCoins(item.price)}`;

                const btn = document.createElement("button");
                btn.className = "register-button";
                btn.textContent = "Buy";
                btn.onclick = () => {
                    if (!currentUser) {
                        showToast("You must be signed in to buy items.", "red");
                        return;
                    }
                    if (isNaN(parseInt(currentCoins))) {
                        showToast("Invalid balance. Please refresh.", "red");
                        return;
                    }
                    if (parseInt(currentCoins) < item.price) {
                        showToast("Insufficient coins for this purchase.", "red");
                        return;
                    }
                    selectedItem = item;
                    confirmTitle.textContent = `Confirm: ${item.title}`;
                    confirmText.textContent = `Do you want to buy ${item.title} for ${formatCoins(item.price)}?`;
                    dialog.showModal();
                };

                box.appendChild(img);
                box.appendChild(title);
                box.appendChild(desc);
                box.appendChild(price);
                box.appendChild(btn);

                shopContainer.appendChild(box);
            });
        }

        document.getElementById("confirm-btn").onclick = async () => {
    if (!selectedItem) return;

    await handlePurchase(selectedItem);
    dialog.close();
};

async function handlePurchase(item) {
    if (!currentUser) {
        showToast("You must be signed in to purchase.", "red");
        return;
    }
    const email = currentUser.email;
    const userDoc = doc(db, "user_data", email);

    try {
        const docSnap = await getDoc(userDoc);
        const data = docSnap.data();
        const currentCoins = parseFloat(data.coins || 0);
        const purchasedIds = data.purchasedIds || [];

        if (purchasedIds.includes(item.productId)) {
            showToast("You already own this item.", "yellow");
            return;
        }
        if (currentCoins < item.price) {
            showToast("Insufficient coins for this purchase.", "red");
            return;
        }

        await updateDoc(userDoc, {
            coins: (currentCoins - item.price).toString(),
            purchasedIds: [...purchasedIds, item.productId]
        });

        // Save transaction to Firestore
        const txRef = doc(db, `transactions/${email}/records/${item.productId}`);
        await setDoc(txRef, {
            amount: item.price,
            date: serverTimestamp(),
            description: item.title,
            image: item.image,
            source: item.author,
            type: "outgoing"
        });

        showToast("Purchase successful!", "purple");
        item.action();
        updateUserData(currentUser);

        // Reload page after toast disappears
        setTimeout(() => {
            location.reload();
        }, 3900); // 3500ms toast + 400ms animation
    } catch (e) {
        console.error("Purchase error:", e);
        showToast("An error occurred while processing your purchase.", "red");
    }
}

        document.getElementById("cancel-btn").onclick = () => dialog.close();

        document.getElementById("theme-toggle").onclick = () => {
            document.body.classList.toggle("light");
            document.getElementById("theme-toggle").textContent =
                document.body.classList.contains("light") ? "â˜€ï¸" : "ðŸŒ™";
        };

        function showToast(message, color = "purple", duration = 3500) {
    const toast = document.getElementById("toast");
    toast.textContent = message;
    toast.className = `${color} show`;
    toast.style.display = "block";
    setTimeout(() => {
        toast.className = `${color} hide`;
        setTimeout(() => {
            toast.style.display = "none";
            toast.className = color;
        }, 400); // match animation duration
    }, duration);
}

        renderShop();
    </script>
</body>
</html>
