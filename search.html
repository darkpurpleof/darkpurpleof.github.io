<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Search Users | DarkPurpleOF's Website</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>

<!-- Topbar -->
<script type="module" src="/dp-topbar.js"></script>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root {
  --bg:#171717; --card:#1f1f1f; --text:#e0e0e0; --muted:#a0a0a0; --border:#2c2c2c;
  --hover:#272727; --accent:#6b21a8;
}

body {
  margin:0; font-family:Inter,system-ui,sans-serif; background:var(--bg); color:var(--text);
  min-height:100vh;
}
dp-topbar { display:block; position:sticky; top:0; z-index:100; }

.main-container {
  max-width:1000px; margin:32px auto; padding:16px; display:flex; flex-direction:column; gap:20px;
}

.search-card {
  background:var(--card); border-radius:12px; padding:16px; border:1px solid var(--border);
  display:flex; flex-direction:column; gap:14px;
}

.search-box {
  display:flex; align-items:center; gap:10px;
  border:1px solid var(--border); border-radius:10px; padding:8px 12px; background:#272727;
}

.search-box img { width:18px; height:18px; }

.search-box input {
  border:none; outline:none; width:100%; background:transparent; font-size:15px; color:var(--text);
}

#results {
  display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:14px;
}

.user-card {
  display:flex; flex-direction:column; align-items:center; gap:10px;
  padding:12px; background:var(--card);
  transition:0.2s all; cursor:pointer;
}
.user-card:hover { background:var(--hover); }

.profile-pic-container { position:relative; width:72px; height:72px; }
.profile-pic {
  width:72px; height:72px; border-radius:12px; object-fit:cover; border:2px solid var(--border);
}
.profile-pic-frame {
  position:absolute; left:0; top:0; width:72px; height:72px; border-radius:12px;
  background-size:cover; background-position:center; display:none; pointer-events:none;
}

.user-name {
  font-size:16px; font-weight:600; text-align:center; color:var(--text); display:flex; align-items:center; gap:6px; justify-content:center;
  word-break:break-word;
}

.verified-icon { width:16px; height:16px; }

#toast {
  position:fixed; top:18px; left:50%; transform:translateX(-50%);
  padding:10px 16px; border-radius:8px; font-weight:600; display:none; z-index:99999;
  background:#333; color:#fff;
}

@media(max-width:600px){
  .profile-pic-container { width:56px; height:56px; }
  .profile-pic, .profile-pic-frame { width:56px; height:56px; }
}
</style>
</head>

<body>
<dp-topbar></dp-topbar>

<main class="main-container">
  <div class="search-card">
    <div class="search-box">
      <img src="/assets/search.png" alt="Search">
      <input id="searchBox" type="text" placeholder="Search users by name or email...">
    </div>
    <div id="results"></div>
  </div>
</main>

<div id="toast"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCAPZF2zwU6z5rhikrIVZ4TVxf1tS5aTbA",
  authDomain: "darkpurpleof-s-website.firebaseapp.com",
  databaseURL: "https://darkpurpleof-s-website-default-rtdb.firebaseio.com",
  projectId: "darkpurpleof-s-website",
  storageBucket: "darkpurpleof-s-website.firebasestorage.app",
  messagingSenderId: "520651082420",
  appId: "1:520651082420:web:bb05c0c3fd64517952e5e1",
  measurementId: "G-S2X2JYC8Z0"
};
if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
let currentUserEmail = null;

function showToast(msg,dur=3000){
  const t=document.getElementById("toast"); t.textContent=msg; t.style.display="block";
  setTimeout(()=>t.style.display="none",dur);
}

function renderUserCard(user, renderedEmails){
  if(renderedEmails.has(user.email)) return;
  renderedEmails.add(user.email);

  const results=document.getElementById("results");
  const card=document.createElement("div"); card.className="user-card";

  const picContainer=document.createElement("div"); picContainer.className="profile-pic-container";
  const img=document.createElement("img"); img.className="profile-pic"; img.src=user.profile_picture||"/org-owner.jpg";
  img.onerror=()=>{img.src="/org-owner.jpg";}
  const frame=document.createElement("div"); frame.className="profile-pic-frame";
  if(user.profile_picture_frame?.trim()){ frame.style.backgroundImage=`url('${user.profile_picture_frame}')`; frame.style.display="block"; }
  picContainer.appendChild(img); picContainer.appendChild(frame);

  const nameDiv=document.createElement("div"); nameDiv.className="user-name";
  const nameSpan=document.createElement("span");
  nameSpan.textContent=user.is_profile_public===false ? user.email : user["display name"]||user.email;
  if(user.is_verified){ const badge=document.createElement("img"); badge.src="/assets/verified.png"; badge.className="verified-icon"; nameSpan.appendChild(badge); }
  nameDiv.appendChild(nameSpan);

  card.appendChild(picContainer);
  card.appendChild(nameDiv);

  card.addEventListener("click",()=>window.location.href=`/viewprofile?profile=${encodeURIComponent(user.email)}`);
  results.appendChild(card);
}

async function fetchUsers(){
  const snapshot=await db.collection("user_data").get();
  return snapshot.docs.map(d=>({ email:d.id, ...d.data() }));
}

function matchesSearch(user, query){
  if(!query) return false; query=query.toLowerCase();
  const isEmail=query.includes("@") && query.includes(".");
  if(isEmail) return user.email.toLowerCase()===query;
  if(user.isProfilePublic===false) return false;
  return user["display name"]?.toLowerCase().includes(query);
}

async function searchUsers(query){
  const results=document.getElementById("results"); results.innerHTML="";
  if(!query.trim()) return;
  const users=await fetchUsers();
  const renderedEmails=new Set();
  users.forEach(user=>{
    if(user.email===currentUserEmail) return;
    if(Array.isArray(user.blockedUsers)&&user.blockedUsers.includes(currentUserEmail)) return;
    if(matchesSearch(user,query)) renderUserCard(user, renderedEmails);
  });
}

auth.onAuthStateChanged(user=>{
  if(!user){ window.location.href="/login"; return; }
  currentUserEmail=user.email;
  document.getElementById("searchBox")?.addEventListener("input", e=>searchUsers(e.target.value));
});
</script>
</body>
</html>
